<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Import from LJ to Golos</title>

    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="node_modules/syncfusion/Content/ej/web/bootstrap-theme/ej.web.all.min.css" rel="stylesheet"/>

    <!-- Essential Studio for JavaScript script references -->
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jquery.easing/jquery.easing.min.js"></script>
    <script src="node_modules/jsrender/jsrender.min.js"></script>
    <script src="node_modules/syncfusion/Scripts/ej/web/ej.web.all.min.js"></script>
    <script src="node_modules/syncfusion/Scripts/ej/i18n/ej.culture.ru-RU.min.js"></script>
</head>
<body>
<div id="root">
    <form id="ljImport" name="ljImport">
        <label for="journalName">Имя блога в ЖЖ:&nbsp</label>
        <input id="journalName" type="text" name="journalName" value="protivoyadie"/>
        <input class="btn btn-success" type="submit" value="Скачать посты из ЖЖ"/>
    </form>
    <form id="postToGolos" name="postToGolos" hidden>
        <div id="ljPostsGrid"></div>
        <label for="golosNickName">Имя профиля в Голосе:&nbsp</label><input id="golosNickName" type="text" value="aly"/>
        <br>
        <label for="golosPostingKey">Приватный ключ для постинга в Голос:&nbsp</label>
        <input value="" id="golosPostingKey" type="password"/>
        <input class="btn btn-success" type="submit" value="Запостить в Голос">
    </form>
    <div id="popup"></div>
</div>
<script>
    var ljImportURL = "http://127.0.0.1:3000/parseblog";
    var golosPostURL = "http://127.0.0.1:3000/postToGolos";
    function renderLJPostsGrid(posts) {
        $("#postToGolos").show();

        var ljPostsGrid = $("#ljPostsGrid");
        ljPostsGrid.data("ejGrid") != undefined && ljPostsGrid.ejGrid("destroy"); //Костыль для syncfusion #166030 bug
        ljPostsGrid.ejGrid({
            dataSource: posts,
            allowSorting: true,
            allowPaging:true,
            pageSettings: { pageSize: 5 },
            allowResizing: true,
            columns: [
                {field: "datetime", headerText: "Время постинга в ЖЖ"},
                {field: "url", headerText: "URL"},
                {field: "subject", headerText: "Заголовок"},
                {field: "post", headerText: "Текст поста"},
                {field: "tags", headerText: "Теги"},
            ],
            showSummary: true,
            summaryRows: [{
                title: "Всего: ",
                summaryColumns: [{
                    summaryType: ej.Grid.SummaryType.Count,
                    displayColumn: "url",
                    dataMember: "url"
                }]
            }],
            allowFiltering: true,
            filterSettings: {filterType: "excel"}
        });
    }
    $(()=> {
        let ljImportForm = document.forms.namedItem("ljImport");
        ljImportForm.addEventListener('submit', (ev) => {
            var popup = $("#popup");

            let oData = new FormData(ljImportForm);
            console.log(oData);
            let xhr = new XMLHttpRequest();
            xhr.open("GET", ljImportURL);

            xhr.onload = (oEvent) => {
                if (xhr.status == 200) {
                    let res = JSON.parse(xhr.responseText);
                    renderLJPostsGrid(res.posts);
                } else {
                    alert("Error " + xhr.status + " occurred");
                }

                popup.data("ejWaitingPopup").hide();
            };
            xhr.send(oData);

            popup.ejWaitingPopup({
                showOnInit: true,
                target: "#root"
            });
            ev.preventDefault();
        }, false);

        let postToGolos = document.forms.namedItem("postToGolos");
        postToGolos.addEventListener('submit', (ev) => {
            var popup = $("#popup");

            let oData = new FormData(postToGolos);
            console.log(oData);
            let xhr = new XMLHttpRequest();
            xhr.open("GET", golosPostURL);

            xhr.onload = (oEvent) => {
                if (xhr.status == 200) {
                    alert('Done!');
                } else {
                    alert("Error " + xhr.status + " occurred");
                }

                popup.data("ejWaitingPopup").hide();
            };
            xhr.send(oData);

            popup.ejWaitingPopup({
                showOnInit: true,
                target: "#root"
            });
            ev.preventDefault();
        }, false);
    });
</script>
</body>
</html>